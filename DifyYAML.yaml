app:
  description: ''
  icon: ğŸ¤–
  icon_background: '#FFEAD5'
  mode: workflow
  name: æ¼«ç”»ã§ã‚ã‹ã‚‹AI
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/openai_tool:0.0.1@be3525b5ffd6f7f7be58a048912edb7822c8835caac366ab164d804459ae76eb
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/gemini:0.2.1@88c1b2c816ef2ea36fc411b35298a621b3260d34bc08bd9357772092728aadde
kind: app
version: 0.3.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_size_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: start
        targetType: llm
      id: 1746700539145-source-1746700545903-target
      selected: false
      source: '1746700539145'
      sourceHandle: source
      target: '1746700545903'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: true
        isInLoop: false
        iteration_id: '1746707845164'
        sourceType: iteration-start
        targetType: llm
      id: 1746707845164start-source-1746707871960-target
      selected: false
      source: 1746707845164start
      sourceHandle: source
      target: '1746707871960'
      targetHandle: target
      type: custom
      zIndex: 1002
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1746700545903-source-1746708458829-target
      selected: false
      source: '1746700545903'
      sourceHandle: source
      target: '1746708458829'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: iteration
      id: 1746708458829-source-1746707845164-target
      selected: false
      source: '1746708458829'
      sourceHandle: source
      target: '1746707845164'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: iteration
        targetType: code
      id: 1746707845164-source-1746788803036-target
      selected: false
      source: '1746707845164'
      sourceHandle: source
      target: '1746788803036'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: iteration
      id: 1746788803036-source-1747134201151-target
      source: '1746788803036'
      sourceHandle: source
      target: '1747134201151'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: iteration
        targetType: end
      id: 1747134201151-source-1746701222868-target
      source: '1747134201151'
      sourceHandle: source
      target: '1746701222868'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: true
        isInLoop: false
        iteration_id: '1747134201151'
        sourceType: iteration-start
        targetType: tool
      id: 1747134201151start-source-1747134234498-target
      source: 1747134201151start
      sourceHandle: source
      target: '1747134234498'
      targetHandle: target
      type: custom
      zIndex: 1002
    nodes:
    - data:
        desc: ''
        selected: false
        title: é–‹å§‹
        type: start
        variables:
        - label: user_question
          max_length: 48
          options: []
          required: true
          type: text-input
          variable: user_question
        - label: user_level
          max_length: 48
          options: []
          required: true
          type: text-input
          variable: user_level
      height: 116
      id: '1746700539145'
      position:
        x: 80
        y: 280.21763115836654
      positionAbsolute:
        x: 80
        y: 280.21763115836654
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: true
          variable_selector:
          - '1746700539145'
          - user_question
        desc: ''
        model:
          completion_params: {}
          mode: chat
          name: gemini-2.5-pro-preview-05-06
          provider: langgenius/gemini/google
        prompt_template:
        - id: 370abf98-3b13-460e-8444-9160980d27c7
          role: system
          text: "ğŸ¯ ã‚ãªãŸã¯æ•™è‚²æ¼«ç”»ã®å°‚é–€ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚ä»Šå›ã®ãƒ†ãƒ¼ãƒã¯ã€Œ{{#1746700539145.user_question#}}ã€ã€å¯¾è±¡ãƒ¬ãƒ™ãƒ«ã¯ã€Œ{{#1746700539145.user_level#}}ã€ã§ã™ã€‚\n\nã€MISSIONã€‘æ¥½ã—ãå­¦ã¹ã¦è¨˜æ†¶ã«æ®‹ã‚‹ã€æœ€é«˜å“è³ªã®æ•™è‚²æ¼«ç”»ã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚\n\nã€KEY IMPROVEMENTSã€‘\nâœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è²«æ€§ã®å¼·åŒ–: ç”»åƒAI ãŒåŒã˜å¤–è¦‹ã‚’å†ç¾ã§ãã‚‹è¶…è©³ç´°è¨˜è¿°\nâœ… èµ·æ‰¿è»¢çµã®å¼·åŒ–: æ„Ÿæƒ…çš„èµ·ä¼ã§èª­è€…ã‚’å¼•ãè¾¼ã‚€æ§‹æˆ\nâœ… ãƒ¬ãƒ™ãƒ«å®Œå…¨é©å¿œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ™ãƒ«ã«æœ€é©åŒ–ã•ã‚ŒãŸå†…å®¹\nâœ… æ•™è‚²åŠ¹æœæœ€å¤§åŒ–: æ®µéšçš„ç†è§£ã¨é•·æœŸè¨˜æ†¶ã‚’ä¿ƒé€²\n\nã€OUTPUT JSON SCHEMAã€‘\n{\n  \"total_panels\": 30-100,\n  \"difficulty_analysis\": {\n    \"topic_complexity\": \"(simple/moderate/complex/very_complex)\",\n    \"recommended_panels\": \"(30-100 based on complexity)\",\n    \"user_level_assessment\": \"{{#1746700539145.user_level#}}\",\n    \"vocabulary_level\": \"(elementary/intermediate/advanced/expert)\",\n    \"explanation_depth\": \"(basic/detailed/comprehensive/technical)\"\n  },\n  \"story_structure\": {\n    \"act1_hook\": {\n      \"panels\": \"1-8\",\n      \"purpose\": \"å¼·åŠ›ãªå°å…¥ã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç¢ºç«‹\",\n      \"emotional_tone\": \"curiosity, wonder, motivation\",\n      \"key_elements\": \"å•é¡Œæèµ·ã€å…±æ„Ÿã€æœŸå¾…æ„Ÿ\"\n    },\n    \"act2_build\": {\n      \"panels\": \"9-70\",\n      \"purpose\": \"æ®µéšçš„çŸ¥è­˜æ§‹ç¯‰ã¨ç†è§£æ·±åŒ–\",\n      \"emotional_tone\": \"discovery, understanding, confidence\",\n      \"key_elements\": \"æ¦‚å¿µèª¬æ˜ã€ä¾‹ç¤ºã€ç·´ç¿’ã€ç¢ºèª\"\n    },\n    \"act3_climax\": {\n      \"panels\": \"71-85\",\n      \"purpose\": \"æŒ‘æˆ¦ã¨å¿œç”¨ã§ç†è§£ã‚’è©¦ã™\",\n      \"emotional_tone\": \"challenge, struggle, breakthrough\",\n      \"key_elements\": \"é›£å•ã€å¿œç”¨ã€æˆåŠŸä½“é¨“\"\n    },\n    \"act4_resolution\": {\n      \"panels\": \"86-100\",\n      \"purpose\": \"é”æˆæ„Ÿã¨æ¬¡ã¸ã®å‹•æ©Ÿä»˜ã‘\",\n      \"emotional_tone\": \"satisfaction, confidence, inspiration\",\n      \"key_elements\": \"ã¾ã¨ã‚ã€é”æˆæ„Ÿã€å°†æ¥å±•æœ›\"\n    }\n  },\n  \"panel_overviews\": [\n    \"ãƒ‘ãƒãƒ«1: [ãƒ•ãƒƒã‚¯] æ—¥å¸¸ã‚·ãƒ¼ãƒ³ã§{{#1746700539145.user_question#}}ã«é–¢ã™ã‚‹å›°ã‚Šã”ã¨ã‚’ç™ºè¦‹\",\n    \"ãƒ‘ãƒãƒ«2: [å°å…¥] ä¸»äººå…¬ã®æ‚©ã¿ã¨ç–‘å•ã®æ˜ç¢ºåŒ–\",\n    \"ãƒ‘ãƒãƒ«3: [å‡ºä¼šã„] çŸ¥è­˜å…ˆç”Ÿã®ç™»å ´ã¨å®‰å¿ƒæ„Ÿã®æä¾›\",\n    \"...ç¶šãæ®µéšçš„ãªå±•é–‹...\"\n  ],\n  \"main_characters\": [\n    {\n      \"name\": \"çŸ¥è­˜å…ˆç”Ÿï¼ˆDr. Knowledgeï¼‰\",\n      \"character_id\": \"teacher_primary\",\n      \"consistency_code\": \"TCHR_001\",\n      \"physical_detailed_description\": {\n        \"face_structure\": \"oval-shaped face with gentle, approachable features, slightly narrow jawline, high cheekbones\",\n        \"eyes\": \"deep blue eyes with gold flecks, kind and attentive expression, slight crow's feet from frequent smiling, medium-thick dark brown eyebrows\",\n        \"nose\": \"straight, well-proportioned nose, neither too large nor small\",\n        \"mouth\": \"warm, encouraging smile with slight natural upturn, showing genuine care and patience\",\n        \"distinctive_facial_marks\": \"small dark mole on left cheek below eye, subtle laugh lines around eyes and mouth\",\n        \"hair_complete_description\": \"dark brown hair with subtle gray streaks at temples, short and neatly styled with side part on left, slightly wavy texture, professional appearance, always well-groomed\",\n        \"skin_tone\": \"fair to light olive complexion with healthy glow, clean-shaven\",\n        \"age_appearance\": \"35 years old, mature but energetic\"\n      },\n      \"body_and_posture\": {\n        \"height\": \"175cm tall\",\n        \"build\": \"average build, slightly lean, good posture with confident stance\",\n        \"distinctive_posture\": \"stands straight with open, welcoming body language\"\n      },\n      \"clothing_strict_consistency\": {\n        \"primary_outfit\": \"crisp white lab coat (knee-length) over light blue button-down shirt and dark navy blue trousers\",\n        \"accessories_always_present\": \"round silver-framed glasses (thin frames), simple silver wristwatch on left wrist, small black notebook visible in lab coat pocket\",\n        \"footwear\": \"dark brown leather dress shoes, well-polished\",\n        \"color_scheme_fixed\": \"white coat, light blue shirt, navy trousers, silver accessories\"\n      },\n      \"personality_and_mannerisms\": {\n        \"core_traits\": \"patient, knowledgeable, encouraging, genuinely caring, intellectually curious\",\n        \"teaching_approach\": \"uses step-by-step explanations, employs relatable analogies, checks understanding frequently\",\n        \"signature_mannerisms\": \"adjusts glasses when thinking deeply, uses expressive hand gestures while explaining, nods encouragingly when student shows understanding\",\n        \"speech_style\": \"calm and clear voice, uses simple language appropriate to student level, asks guiding questions\"\n      },\n      \"role_in_story\": \"ä¸»è¦ãªè§£èª¬è€…ã¨ã—ã¦{{#1746700539145.user_question#}}ã«ã¤ã„ã¦æ®µéšçš„ã«æ•™ãˆã‚‹å½¹å‰²\",\n      \"image_generation_consistency_rules\": \"CRITICAL: å¿…ãšç™½ã„ãƒ©ãƒœã‚³ãƒ¼ãƒˆç€ç”¨ã€ä¸¸ã„éŠ€ç¸çœ¼é¡ã€ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ©ã‚¦ãƒ³ã®é«ªã€å·¦é ¬ã®å°ã•ãªã»ãã‚ã€å„ªã—ã„é’ã„ç›®ã€‚æœè£…ã¨å¤–è¦‹ã¯å…¨ã‚³ãƒã§å®Œå…¨ã«çµ±ä¸€ã€‚\"\n    },\n    {\n      \"name\": \"å­¦ã³å›ï¼ˆManabi-kunï¼‰\",\n      \"character_id\": \"student_primary\",\n      \"consistency_code\": \"STUD_001\",\n      \"physical_detailed_description\": {\n        \"face_structure\": \"round, youthful face with soft features, full cheeks, small chin\",\n        \"eyes\": \"large, bright brown eyes that sparkle with curiosity, expressive eyebrows that move with emotions, thick black eyelashes\",\n        \"nose\": \"small, slightly upturned nose, youthful appearance\",\n        \"mouth\": \"frequently smiling, shows emotions clearly from confusion to excitement to understanding\",\n        \"distinctive_facial_marks\": \"no scars or marks, clean youthful appearance with rosy cheeks when excited\",\n        \"hair_complete_description\": \"jet black hair, medium length reaching just below ears, slightly messy with natural volume, side-swept bangs that sometimes fall over right eye\",\n        \"skin_tone\": \"light skin with healthy glow, smooth youthful complexion\",\n        \"age_appearance\": \"age appropriate to {{#1746700539145.user_level#}} level\"\n      },\n      \"body_and_posture\": {\n        \"height\": \"height appropriate for stated age/level\",\n        \"build\": \"slim, energetic build with good posture when focused\",\n        \"distinctive_posture\": \"leans forward when interested, sits up straight when understanding\"\n      },\n      \"clothing_strict_consistency\": {\n        \"primary_outfit\": \"school uniform: crisp white button-down shirt, navy blue blazer with school emblem, dark gray trousers\",\n        \"accessories_always_present\": \"bright red necktie neatly tied, small navy blue backpack with silver zippers\",\n        \"footwear\": \"black school shoes with white socks\",\n        \"color_scheme_fixed\": \"white shirt, navy blazer, red tie, dark gray pants\"\n      },\n      \"personality_and_mannerisms\": {\n        \"core_traits\": \"curious, eager to learn, sometimes confused but never gives up, genuinely enthusiastic\",\n        \"learning_style\": \"learns by asking questions, needs visual examples, gets excited by new discoveries\",\n        \"signature_mannerisms\": \"tilts head when confused, eyes widen and sparkle when understanding clicks, takes notes enthusiastically\",\n        \"speech_style\": \"enthusiastic and energetic voice, frequently asks 'Why?' and 'How?', uses casual but polite language\"\n      },\n      \"role_in_story\": \"{{#1746700539145.user_question#}}ã«ã¤ã„ã¦å­¦ã¶ä»£è¡¨çš„ãªç”Ÿå¾’ã¨ã—ã¦ã€èª­è€…ã¨åŒã˜è¦–ç‚¹ã§æ®µéšçš„ã«ç†è§£ã—ã¦ã„ã\",\n      \"image_generation_consistency_rules\": \"CRITICAL: å¿…ãšå­¦ç”Ÿæœç€ç”¨ï¼ˆç™½ã‚·ãƒ£ãƒ„+ç´ºãƒ–ãƒ¬ã‚¶ãƒ¼+èµ¤ãƒã‚¯ã‚¿ã‚¤ï¼‰ã€é»’é«ªã§å‰é«ªãŒå³ç›®ã«ã‹ã‹ã‚‹ã€å¤§ããªèŒ¶è‰²ã„ç›®ã€å¥½å¥‡å¿ƒã‚ãµã‚Œã‚‹è¡¨æƒ…ã€‚æœè£…ã¨å¤–è¦‹ã¯å…¨ã‚³ãƒã§å®Œå…¨çµ±ä¸€ã€‚\"\n    }\n  ],\n  \"visual_style_guide\": {\n    \"art_style\": \"clean educational manga style with clear line art, professional illustration quality suitable for learning materials\",\n    \"character_rendering\": {\n      \"consistency_priority\": \"MAXIMUM - characters must look identical across all panels\",\n      \"line_quality\": \"clean, consistent line weights, professional manga style\",\n      \"shading_style\": \"soft cell shading with educational-friendly lighting\"\n    },\n    \"color_palette\": {\n      \"primary_educational_colors\": \"bright blue (#0066CC), vibrant green (#00AA44), warm orange (#FF6600)\",\n      \"character_color_schemes\": \"strictly consistent character-specific colors throughout\",\n      \"background_colors\": \"soft, non-distracting colors that enhance readability\"\n    },\n    \"panel_design\": {\n      \"layout_principles\": \"clear focal points, uncluttered composition, easy visual flow\",\n      \"text_integration\": \"readable speech bubbles, well-placed educational text overlays\",\n      \"visual_hierarchy\": \"important information prominently displayed\"\n    }\n  },\n  \"educational_framework\": {\n    \"learning_objectives\": [\n      \"{{#1746700539145.user_question#}}ã®åŸºæœ¬æ¦‚å¿µã®å®Œå…¨ç†è§£\",\n      \"æ®µéšçš„ã§ç¢ºå®ŸãªçŸ¥è­˜æ§‹ç¯‰\",\n      \"å®Ÿç”¨çš„ãªå¿œç”¨èƒ½åŠ›ã®ç²å¾—\",\n      \"è‡ªä¿¡ã‚’æŒã£ãŸçŸ¥è­˜æ´»ç”¨\"\n    ],\n    \"pedagogical_methods\": {\n      \"primary_approach\": \"narrative-based constructivist learning\",\n      \"engagement_techniques\": \"storytelling, character development, visual metaphors, interactive dialogue\",\n      \"difficulty_progression\": \"carefully graduated from basic to advanced concepts\",\n      \"retention_strategies\": \"repetition through character dialogue, visual reinforcement, emotional connection\"\n    },\n    \"level_specific_adaptations\": {\n      \"vocabulary_control\": \"{{#1746700539145.user_level#}}ãƒ¬ãƒ™ãƒ«ã«å®Œå…¨é©å¿œã—ãŸç”¨èªé¸æŠ\",\n      \"concept_depth\": \"ç†è§£ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸèª¬æ˜ã®è©³ç´°åº¦èª¿æ•´\",\n      \"visual_complexity\": \"èªçŸ¥è² è·ã‚’è€ƒæ…®ã—ãŸè¦–è¦šçš„è¤‡é›‘ã•ã®æœ€é©åŒ–\",\n      \"pacing_control\": \"å­¦ç¿’è€…ã®èªçŸ¥èƒ½åŠ›ã«åˆã‚ã›ãŸãƒšãƒ¼ã‚¹è¨­å®š\"\n    }\n  }\n}\n\nã€CRITICAL REQUIREMENTSã€‘\nğŸ¯ total_panels: 30-100ã‚³ãƒï¼ˆè¤‡é›‘ã•ã«å¿œã˜ã¦æœ€é©åŒ–ï¼‰\nğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨˜è¿°: ç”»åƒAIãŒä¸€è²«ã—ãŸå¤–è¦‹ã‚’ç”Ÿæˆã§ãã‚‹è©³ç´°ã•\nğŸ¯ panel_overviews: èµ·æ‰¿è»¢çµã®æ„Ÿæƒ…çš„èµ·ä¼ã‚’é‡è¦–ã—ãŸã‚¹ãƒˆãƒ¼ãƒªãƒ¼\nğŸ¯ ãƒ¬ãƒ™ãƒ«é©å¿œ: {{#1746700539145.user_level#}}ã«å®Œå…¨å¯¾å¿œã—ãŸå†…å®¹è¨­è¨ˆ\n\n**ç´”ç²‹JSONã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã‚„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ä¸è¦ã€‚**"
        - id: efc68e32-71e6-4874-bb23-b928629b234f
          role: user
          text: 'è³ªå•:{{#1746700539145.user_question#}}

            ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ™ãƒ«: {{#1746700539145.user_level#}}'
        selected: false
        structured_output:
          schema:
            properties:
              educational_progression:
                items:
                  type: string
                type: array
              main_characters:
                items:
                  properties:
                    name:
                      type: string
                  required:
                  - name
                  type: object
                type: array
              overall_style_suggestion:
                type: string
              panel_overviews:
                items:
                  type: string
                type: array
              story_arc:
                properties:
                  phase_overview:
                    type: string
                required:
                - phase_overview
                type: object
              total_panels:
                minimum: 20
                type: integer
              visual_consistency_rules:
                properties:
                  character_style:
                    type: string
                required:
                - character_style
                type: object
            required:
            - total_panels
            - panel_overviews
            type: object
        structured_output_enabled: true
        title: LLM
        type: llm
        variables: []
        vision:
          enabled: false
      height: 90
      id: '1746700545903'
      position:
        x: 370.7572851944793
        y: 270.29416380600645
      positionAbsolute:
        x: 370.7572851944793
        y: 270.29416380600645
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: ''
        outputs:
        - value_selector:
          - '1747134201151'
          - output
          variable: text
        selected: false
        title: çµ‚äº†
        type: end
      height: 90
      id: '1746701222868'
      position:
        x: 2283.967114994708
        y: 295.1417343060362
      positionAbsolute:
        x: 2283.967114994708
        y: 295.1417343060362
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: ''
        error_handle_mode: terminated
        height: 178
        is_parallel: true
        iterator_selector:
        - '1746708458829'
        - iteration_input_list
        output_selector:
        - '1746707871960'
        - text
        output_type: array[string]
        parallel_nums: 10
        selected: false
        start_node_id: 1746707845164start
        title: ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ 2
        type: iteration
        width: 388
      height: 178
      id: '1746707845164'
      position:
        x: 983.8521809021856
        y: 264.41393682793336
      positionAbsolute:
        x: 983.8521809021856
        y: 264.41393682793336
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 388
      zIndex: 1
    - data:
        desc: ''
        isInIteration: true
        selected: false
        title: ''
        type: iteration-start
      draggable: false
      height: 48
      id: 1746707845164start
      parentId: '1746707845164'
      position:
        x: 24
        y: 68
      positionAbsolute:
        x: 1007.8521809021856
        y: 332.41393682793336
      selectable: false
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom-iteration-start
      width: 44
      zIndex: 1002
    - data:
        context:
          enabled: true
          variable_selector:
          - '1746707845164'
          - item
        desc: ''
        isInIteration: true
        isInLoop: false
        iteration_id: '1746707845164'
        model:
          completion_params: {}
          mode: chat
          name: gemini-2.5-pro-preview-05-06
          provider: langgenius/gemini/google
        prompt_template:
        - id: d77c8fe9-e9f6-4ff3-8e9f-91d3ab701b16
          role: system
          text: "ğŸ¨ ã‚ãªãŸã¯æ•™è‚²æ¼«ç”»ã®ã€1ã‚³ãƒå°‚é–€ã€‘ã‚·ãƒŠãƒªã‚ªãƒ©ã‚¤ã‚¿ãƒ¼å…¼ã‚¤ãƒ©ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ã§ã™ã€‚\n\nã€MISSIONã€‘ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è²«æ€§ã‚’æœ€å„ªå…ˆã«ã€æ•™è‚²åŠ¹æœã®é«˜ã„1ã‚³ãƒã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚\n\nã€INPUT DATAã€‘\nğŸ“š ãƒ†ãƒ¼ãƒ: {{#1746700539145.user_question#}}\nğŸ‘¤ å¯¾è±¡ãƒ¬ãƒ™ãƒ«: {{#1746700539145.user_level#}}\nğŸ¬ ã‚³ãƒç•ªå·: {{item.panel_number}}\nğŸ“Š é€²è¡ŒçŠ¶æ³: {{item.progress_percentage}}%\nğŸ­ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ•ã‚§ãƒ¼ã‚º: {{item.story_phase}}\nğŸ“– ã“ã®ã‚³ãƒã®å½¹å‰²: {{item.panel_overview}}\nğŸ‘¥ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š: {{item.main_characters_json_string}}\nğŸ¨ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ«ãƒ¼ãƒ«: {{item.visual_consistency_rules}}\n\n{{#if item.previous_panels_json_string}}\nğŸ“º å‰ã®ã‚³ãƒã®æµã‚Œ: {{item.previous_panels_json_string}}\n{{/if}}\n\nã€CRITICAL OUTPUT JSONã€‘\n{\n  \"panel_id\": {{item.panel_number}},\n  \"consistency_check\": {\n    \"character_validation\": \"PASS - all characters match established descriptions\",\n    \"visual_style_validation\": \"PASS - consistent with previous panels\",\n    \"story_continuity_validation\": \"PASS - flows naturally from previous panels\"\n  },\n  \"scene_description\": \"ï¼ˆã‚·ãƒ¼ãƒ³ã®è©³ç´°æå†™ï¼šå ´æ‰€ã€æ™‚åˆ»ã€é›°å›²æ°—ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é…ç½®ã€é‡è¦ãªèƒŒæ™¯è¦ç´ ï¼‰\",\n  \"camera_angle\": \"ï¼ˆæ’®å½±ã‚¢ãƒ³ã‚°ãƒ«: close-up/medium shot/wide shot/bird's eye view/low angleç­‰ï¼‰\",\n  \"lighting\": \"ï¼ˆç…§æ˜è¨­å®š: bright classroom lighting/soft afternoon sun/dramatic spotlightç­‰ï¼‰\",\n  \"characters\": [\n    {\n      \"name\": \"ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å - main_charactersã¨å®Œå…¨ä¸€è‡´ï¼‰\",\n      \"consistency_code\": \"ï¼ˆä¾‹: TCHR_001, STUD_001ï¼‰\",\n      \n      // â˜…â˜…â˜… CRITICAL: main_charactersã‹ã‚‰ã®å®Œå…¨ã‚³ãƒ”ãƒ¼ â˜…â˜…â˜…\n      \"physical_appearance\": {\n        \"face_structure\": \"ï¼ˆmain_charactersã‹ã‚‰å®Œå…¨ã‚³ãƒ”ãƒ¼ï¼‰\",\n        \"eyes\": \"ï¼ˆmain_charactersã‹ã‚‰å®Œå…¨ã‚³ãƒ”ãƒ¼ï¼‰\",\n        \"hair_complete\": \"ï¼ˆè‰²ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ãƒ»è³ªæ„Ÿã™ã¹ã¦å®Œå…¨ã‚³ãƒ”ãƒ¼ï¼‰\",\n        \"distinctive_marks\": \"ï¼ˆã»ãã‚ç­‰ã®ç‰¹å¾´ã‚’å®Œå…¨ã‚³ãƒ”ãƒ¼ï¼‰\",\n        \"skin_tone\": \"ï¼ˆmain_charactersã‹ã‚‰å®Œå…¨ã‚³ãƒ”ãƒ¼ï¼‰\"\n      },\n      \"clothing_exact\": {\n        \"outfit\": \"ï¼ˆmain_charactersã‹ã‚‰å®Œå…¨ã‚³ãƒ”ãƒ¼ - ä¸€åˆ‡å¤‰æ›´ç¦æ­¢ï¼‰\",\n        \"accessories\": \"ï¼ˆçœ¼é¡ãƒ»ãƒã‚¯ã‚¿ã‚¤ç­‰ã‚’å®Œå…¨ã‚³ãƒ”ãƒ¼ - ä¸€åˆ‡å¤‰æ›´ç¦æ­¢ï¼‰\",\n        \"color_scheme\": \"ï¼ˆè‰²è¨­å®šã‚’å®Œå…¨ã‚³ãƒ”ãƒ¼ï¼‰\"\n      },\n      \n      // ã“ã®ã‚³ãƒå›ºæœ‰ã®æƒ…å ±\n      \"pose_and_action\": {\n        \"pose\": \"ï¼ˆå…·ä½“çš„ãªãƒãƒ¼ã‚º: standing with arms crossed/sitting at desk/pointing to boardï¼‰\",\n        \"facial_expression\": \"ï¼ˆè¡¨æƒ…: concentrated thinking/excited realization/gentle encouraging smileï¼‰\",\n        \"body_language\": \"ï¼ˆä½“ã®å‹•ã: leaning forward with interest/standing straight with confidenceï¼‰\",\n        \"current_action\": \"ï¼ˆç¾åœ¨ã®è¡Œå‹•: explaining with hand gestures/writing notes/listening intentlyï¼‰\"\n      },\n      \"position_in_frame\": \"ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ å†…ä½ç½®: left side facing right/center of frame/background rightï¼‰\",\n      \"interaction_target\": \"ï¼ˆèª°ã¨/ä½•ã¨ç›¸äº’ä½œç”¨ã—ã¦ã„ã‚‹ã‹ï¼‰\"\n    }\n  ],\n  \"background_elements\": [\n    {\n      \"element_type\": \"ï¼ˆè¦ç´ ã‚¿ã‚¤ãƒ—: classroom/laboratory/outdoor scene/diagram boardï¼‰\",\n      \"description\": \"ï¼ˆè©³ç´°èª¬æ˜: modern classroom with whiteboard and desksï¼‰\",\n      \"educational_relevance\": \"ï¼ˆæ•™è‚²çš„é–¢é€£æ€§: supports {{#1746700539145.user_question#}} explanationï¼‰\",\n      \"position\": \"ï¼ˆé…ç½®: background center/left wall/right cornerï¼‰\",\n      \"prominence\": \"ï¼ˆç›®ç«‹ã¡åº¦: subtle background/moderate focus/key focal pointï¼‰\"\n    }\n  ],\n  \"dialogue_and_text\": [\n    {\n      \"speaker\": \"ï¼ˆè©±è€…å - charactersã®nameã¨ä¸€è‡´ï¼‰\",\n      \"text\": \"ï¼ˆã‚»ãƒªãƒ•: 5-20æ–‡å­—ã€{{#1746700539145.user_level#}}ãƒ¬ãƒ™ãƒ«ã«é©ã—ãŸèªå½™ï¼‰\",\n      \"speech_type\": \"ï¼ˆdialogue/thought/narration/explanationï¼‰\",\n      \"emotion_tone\": \"ï¼ˆæ„Ÿæƒ…: curious/excited/confused/confident/encouragingï¼‰\",\n      \"bubble_style\": \"ï¼ˆå¹ãå‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«: normal/thought/shout/whisperï¼‰\",\n      \"bubble_position\": \"ï¼ˆå¹ãå‡ºã—ä½ç½®: top left/center right/bottomï¼‰\",\n      \"educational_purpose\": \"ï¼ˆæ•™è‚²ç›®çš„: introduce concept/clarify doubt/reinforce understandingï¼‰\"\n    }\n  ],\n  \"educational_visual_elements\": [\n    {\n      \"element_type\": \"ï¼ˆæ•™è‚²è¦ç´ : diagram/chart/formula/illustration/arrow/text_boxï¼‰\",\n      \"content\": \"ï¼ˆå…·ä½“çš„å†…å®¹: {{#1746700539145.user_question#}}ã«é–¢é€£ã™ã‚‹è¦–è¦šçš„èª¬æ˜ï¼‰\",\n      \"purpose\": \"ï¼ˆç›®çš„: explain concept/show relationship/highlight key pointï¼‰\",\n      \"position\": \"ï¼ˆé…ç½®: integrated with scene/overlay on background/separate panel areaï¼‰\",\n      \"complexity_level\": \"ï¼ˆè¤‡é›‘ã•: simple for {{#1746700539145.user_level#}}ï¼‰\"\n    }\n  ],\n  \"story_flow\": {\n    \"connection_from_previous\": \"ï¼ˆå‰ã‚³ãƒã‹ã‚‰ã®æ¥ç¶š: builds on previous explanation/continues dialogue/shows resultï¼‰\",\n    \"main_story_purpose\": \"ï¼ˆã“ã®ã‚³ãƒã®ä¸»ç›®çš„: introduce new concept/deepen understanding/provide exampleï¼‰\",\n    \"emotional_progression\": \"ï¼ˆæ„Ÿæƒ…ã®å¤‰åŒ–: confusion to understanding/curiosity to excitementï¼‰\",\n    \"setup_for_next\": \"ï¼ˆæ¬¡ã‚³ãƒã¸ã®æº–å‚™: poses new question/sets up example/creates anticipationï¼‰\"\n  },\n  \"visual_consistency_enforcement\": {\n    \"character_appearance_check\": \"VERIFIED - matches main_characters exactly\",\n    \"color_scheme_check\": \"VERIFIED - consistent with established palette\",\n    \"art_style_check\": \"VERIFIED - maintains educational manga style\",\n    \"quality_standard\": \"professional educational illustration quality\"\n  }\n}\n\nã€ABSOLUTE REQUIREMENTSã€‘\nğŸ”’ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¤–è¦‹: main_charactersã‹ã‚‰ã®å®Œå…¨ã‚³ãƒ”ãƒ¼å¿…é ˆ\nğŸ”’ æœè£…ãƒ»ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼: ä¸€åˆ‡ã®å¤‰æ›´ç¦æ­¢\nğŸ”’ ç‰¹å¾´çš„ãªå°ï¼ˆã»ãã‚ãƒ»çœ¼é¡ç­‰ï¼‰: å¿…ãšå«ã‚ã‚‹\nğŸ”’ ã‚»ãƒªãƒ•: {{#1746700539145.user_level#}}ãƒ¬ãƒ™ãƒ«ã«æœ€é©åŒ–\nğŸ”’ æ•™è‚²åŠ¹æœ: {{#1746700539145.user_question#}}ã®ç†è§£ä¿ƒé€²\n\n**ç´”ç²‹JSONã®ã¿å‡ºåŠ›ã€‚èª¬æ˜æ–‡ä¸è¦ã€‚**"
        - id: 951bf6ce-f278-421e-bcbe-b14a4895cf94
          role: user
          text: '{{#1746700539145.user_question#}}

            {{#1746700539145.user_level#}}

            {{#1746708458829.overall_style_output#}}

            {{#1746707845164.index#}}

            {{#1746707845164.item#}}

            {{#1746700545903.text#}}'
        selected: false
        title: LLM 2
        type: llm
        variables: []
        vision:
          enabled: false
      height: 90
      id: '1746707871960'
      parentId: '1746707845164'
      position:
        x: 126.86339869177027
        y: 65.31423751592655
      positionAbsolute:
        x: 1110.715579593956
        y: 329.7281743438599
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
      zIndex: 1002
    - data:
        code: "import json\nimport re\n\ndef main(planning_json_string: str, user_question_input:\
          \ str = None, user_level_input: str = None) -> dict:\n    \"\"\"\n    Parameters\n\
          \    ----------\n    planning_json_string      : str  è¨ˆç”»ãƒ•ã‚§ãƒ¼ã‚º LLM ã® JSON\
          \ æ–‡å­—åˆ—\n    user_question_input       : str  é–‹å§‹ãƒãƒ¼ãƒ‰ã‹ã‚‰æ¸¡ã™è³ªå•æ–‡ï¼ˆä»»æ„ï¼‰\n    user_level_input\
          \          : str  é–‹å§‹ãƒãƒ¼ãƒ‰ã‹ã‚‰æ¸¡ã™å­¦å¹´ / é›£æ˜“åº¦ï¼ˆä»»æ„ï¼‰\n    \"\"\"\n    \n    # ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’mainå†…ã§å®šç¾©\n\
          \    def determine_story_phase(panel_num: int, total_panels: int, story_arc:\
          \ dict) -> str:\n        \"\"\"ãƒ‘ãƒãƒ«ç•ªå·ã‹ã‚‰ç‰©èªã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’åˆ¤å®š\"\"\"\n        progress\
          \ = panel_num / total_panels\n        \n        if progress <= 0.1:\n  \
          \          return \"introduction\"\n        elif progress <= 0.8:\n    \
          \        return \"development\"\n        elif progress <= 0.9:\n       \
          \     return \"climax\"\n        else:\n            return \"resolution\"\
          \n    \n    # ------ 1) å…¥åŠ›ã®å–å¾— ------\n    if not planning_json_string:\n\
          \        return {\n            \"error\": \"planning_json_string ãŒæ¸¡ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\"\
          ,\n            \"iteration_input_list\": [],\n            \"overall_style_output\"\
          : \"default comic style\"\n        }\n\n    # ------ ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®é™¤å»å‡¦ç†\
          \ ------\n    match = re.search(r\"```(?:json)?\\s*([\\s\\S]*?)\\s*```\"\
          , planning_json_string)\n    if match:\n        cleaned_json_str = match.group(1).strip()\n\
          \    else:\n        cleaned_json_str = planning_json_string.strip()\n  \
          \  \n    # ------ 2) JSON è§£æ ------\n    try:\n        plan_data = json.loads(cleaned_json_str)\n\
          \    except json.JSONDecodeError as e:\n        return {\n            \"\
          error\": f\"Planning JSON ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—: {e}\",\n            \"cleaned_input_attempt\"\
          : cleaned_json_str,\n            \"raw_input\": planning_json_string,\n\
          \            \"iteration_input_list\": [],\n            \"overall_style_output\"\
          : \"default comic style\"\n        }\n\n    # ãƒ‡ãƒ¼ã‚¿ã®å–å¾—\n    total_panels =\
          \ plan_data.get(\"total_panels\", 0)\n    panel_overviews = plan_data.get(\"\
          panel_overviews\", [])\n    main_characters_info = plan_data.get(\"main_characters\"\
          , [])\n    visual_consistency_rules = plan_data.get(\"visual_consistency_rules\"\
          , {})\n    story_arc = plan_data.get(\"story_arc\", {})\n    \n    # overall_style\
          \ ã‚’å–å¾—ã¾ãŸã¯ç”Ÿæˆ\n    if \"overall_style_suggestion\" in plan_data:\n        overall_style\
          \ = plan_data.get(\"overall_style_suggestion\", \"default comic style\"\
          )\n    elif isinstance(visual_consistency_rules, dict):\n        art_style\
          \ = visual_consistency_rules.get('art_style', 'manga style')\n        color_palette\
          \ = visual_consistency_rules.get('color_palette', 'bright colors')\n   \
          \     overall_style = f\"{art_style}, {color_palette}\"\n    else:\n   \
          \     overall_style = \"clear manga style, bright educational colors\"\n\
          \n    # ------ 3) å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ ------\n    if not isinstance(total_panels, int)\
          \ or total_panels <= 0:\n        return {\n            \"error\": f\"'total_panels'={total_panels}\
          \ ã¯ 1 ä»¥ä¸Šã®æ•´æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\",\n            \"iteration_input_list\": [],\n \
          \           \"overall_style_output\": overall_style\n        }\n\n    if\
          \ len(panel_overviews) != total_panels:\n        return {\n            \"\
          error\": f\"ç·ãƒ‘ãƒãƒ«æ•° {total_panels} ã¨ panel_overviews ã®é•·ã• {len(panel_overviews)}\
          \ ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚\",\n            \"iteration_input_list\": [],\n            \"\
          overall_style_output\": overall_style\n        }\n\n    # ------ 4) å¤‰æ›å‡¦ç†\
          \ ------\n    iteration_items = []\n    \n    # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›\n  \
          \  if main_characters_info is None or not isinstance(main_characters_info,\
          \ list):\n        characters_json = json.dumps([], ensure_ascii=False)\n\
          \    else:\n        characters_json = json.dumps(main_characters_info, ensure_ascii=False)\n\
          \    \n    # å‰ã®ãƒ‘ãƒãƒ«ã®æƒ…å ±ã‚’ä¿æŒã™ã‚‹å¤‰æ•°\n    previous_panels_json = []\n    \n    for\
          \ idx in range(total_panels):\n        # ç¾åœ¨ã®ãƒ‘ãƒãƒ«ã®æƒ…å ±\n        current_panel_info\
          \ = {\n            \"panel_number\": idx + 1,\n            \"panel_overview\"\
          : panel_overviews[idx] if idx < len(panel_overviews) else \"No overview\
          \ available\",\n            \"main_characters_json_string\": characters_json,\n\
          \            \"overall_style\": overall_style,\n            \"user_question\"\
          : user_question_input if user_question_input else \"\",\n            \"\
          user_level\": user_level_input if user_level_input else \"\",\n        \
          \    \"visual_consistency_rules\": json.dumps(visual_consistency_rules,\
          \ ensure_ascii=False) if visual_consistency_rules else \"{}\",\n       \
          \     \"story_arc\": json.dumps(story_arc, ensure_ascii=False) if story_arc\
          \ else \"{}\",\n            \"previous_panel_json_string\": json.dumps(previous_panels_json[-3:],\
          \ ensure_ascii=False) if previous_panels_json else \"\",\n            \"\
          progress_percentage\": round((idx + 1) / total_panels * 100, 1),\n     \
          \       \"story_phase\": determine_story_phase(idx + 1, total_panels, story_arc)\n\
          \        }\n        \n        iteration_items.append(current_panel_info)\n\
          \        \n        # ã“ã®ãƒ‘ãƒãƒ«ã®æ¦‚è¦ã‚’å±¥æ­´ã«è¿½åŠ \n        previous_panels_json.append({\n\
          \            \"panel_id\": idx + 1,\n            \"overview\": panel_overviews[idx]\
          \ if idx < len(panel_overviews) else \"\"\n        })\n\n    # ------ 5)\
          \ å‡ºåŠ› ------\n    return {\n        \"iteration_input_list\": iteration_items,\n\
          \        \"overall_style_output\": overall_style\n    }"
        code_language: python3
        desc: ''
        outputs:
          iteration_input_list:
            children: null
            type: array[object]
          overall_style_output:
            children: null
            type: string
        selected: false
        title: è¨ˆç”»JSONãƒ‘ãƒ¼ã‚¹ç”¨
        type: code
        variables:
        - value_selector:
          - '1746700545903'
          - text
          variable: planning_json_string
        - value_selector:
          - '1746700539145'
          - user_question
          variable: user_question_input
        - value_selector:
          - '1746700539145'
          - user_level
          variable: user_level_input
      height: 54
      id: '1746708458829'
      position:
        x: 676.0320656468683
        y: 270.29416380600645
      positionAbsolute:
        x: 676.0320656468683
        y: 270.29416380600645
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "import json\nimport re\n\ndef main(panel_jsons_input) -> dict:\n  \
          \  \"\"\"\n    Parameters\n    ----------\n    panel_jsons_input : ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ‰ã‹ã‚‰ã®ãƒ‘ãƒãƒ«JSONæ–‡å­—åˆ—ã®ãƒªã‚¹ãƒˆ\n\
          \    \"\"\"\n    \n    # ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’mainå†…ã§å®šç¾©\n    def construct_image_prompt_from_panel_dict(panel_data:\
          \ dict, overall_style: str) -> str:\n        \"\"\"\n        1ãƒ‘ãƒãƒ«åˆ†ã®è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€ç”»åƒç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—ã‚’çµ„ã¿ç«‹ã¦ã‚‹ã€‚\n\
          \        \"\"\"\n        if not isinstance(panel_data, dict):\n        \
          \    return \"Error: Invalid panel_data, expected a dictionary.\"\n\n  \
          \      parts = []\n        \n        # ãƒ‘ãƒãƒ«ç•ªå·ã‚’å«ã‚ã‚‹\n        panel_id = panel_data.get(\"\
          panel_id\", \"unknown\")\n        parts.append(f\"Educational manga panel\
          \ {panel_id}\")\n        \n        # ã‚·ãƒ¼ãƒ³èª¬æ˜\n        scene_desc = panel_data.get(\"\
          scene_description\", panel_data.get(\"description\", \"\"))\n        if\
          \ scene_desc:\n            parts.append(f\"Scene: {scene_desc}\")\n    \
          \    \n        # ã‚«ãƒ¡ãƒ©ã‚¢ãƒ³ã‚°ãƒ«ã¨ç…§æ˜\n        camera = panel_data.get(\"camera_angle\"\
          , \"medium shot\")\n        lighting = panel_data.get(\"lighting\", \"bright\
          \ clear lighting\")\n        parts.append(f\"Camera: {camera}, Lighting:\
          \ {lighting}\")\n        \n        # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±\n        character_prompts\
          \ = []\n        for char_info in panel_data.get(\"characters\", []):\n \
          \           if not isinstance(char_info, dict):\n                continue\n\
          \            \n            char_parts = []\n            name = char_info.get(\"\
          name\", \"character\")\n            \n            # åŸºæœ¬æƒ…å ±ã®æ§‹ç¯‰\n          \
          \  char_parts.append(f\"Character '{name}'\")\n            \n          \
          \  # å¤–è¦‹æƒ…å ±\n            if char_info.get('species'):\n                char_parts.append(f\"\
          appearance: {char_info.get('species')}\")\n            if char_info.get('hair_style')\
          \ and char_info.get('hair_color'):\n                char_parts.append(f\"\
          with {char_info.get('hair_style')} in {char_info.get('hair_color')}\")\n\
          \            if char_info.get('eye_color'):\n                char_parts.append(f\"\
          {char_info.get('eye_color')} eyes\")\n            if char_info.get('clothing'):\n\
          \                char_parts.append(f\"wearing {char_info.get('clothing')}\"\
          )\n            if char_info.get('accessories'):\n                char_parts.append(f\"\
          with {char_info.get('accessories')}\")\n            \n            # ç‰¹å¾´çš„ãªè¦ç´ \n\
          \            features = char_info.get('features', char_info.get('distinctive_features'))\n\
          \            if features:\n                char_parts.append(f\"distinctive\
          \ features: {features}\")\n            \n            # ãƒãƒ¼ã‚ºã¨è¡¨æƒ…\n        \
          \    if char_info.get('pose'):\n                char_parts.append(f\"pose:\
          \ {char_info.get('pose')}\")\n            if char_info.get('expression'):\n\
          \                char_parts.append(f\"expression: {char_info.get('expression')}\"\
          )\n            \n            character_prompts.append(\", \".join(filter(None,\
          \ char_parts)))\n        \n        if character_prompts:\n            parts.append(\"\
          Characters: \" + \"; \".join(character_prompts))\n        \n        # èƒŒæ™¯\n\
          \        backgrounds = panel_data.get(\"background\", [])\n        if backgrounds\
          \ and isinstance(backgrounds, list):\n            valid_backgrounds = [str(bg)\
          \ for bg in backgrounds if bg]\n            if valid_backgrounds:\n    \
          \            parts.append(f\"Background: {', '.join(valid_backgrounds)}\"\
          )\n        \n        # ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ\n        visual_effects = panel_data.get(\"\
          visual_effects\", [])\n        if visual_effects and isinstance(visual_effects,\
          \ list):\n            valid_effects = [str(ve) for ve in visual_effects\
          \ if ve]\n            if valid_effects:\n                parts.append(\"\
          Visual effects: \" + \", \".join(valid_effects))\n        \n        # åŠ¹æœéŸ³\n\
          \        sfx_list = panel_data.get(\"sfx\", [])\n        if sfx_list and\
          \ isinstance(sfx_list, list):\n            sfx_texts = []\n            for\
          \ sfx in sfx_list:\n                if isinstance(sfx, dict) and sfx.get(\"\
          text\"):\n                    sfx_texts.append(sfx.get(\"text\"))\n    \
          \            elif isinstance(sfx, str):\n                    sfx_texts.append(sfx)\n\
          \            if sfx_texts:\n                parts.append(f\"Sound effects:\
          \ {', '.join(sfx_texts)}\")\n        \n        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®çµ„ã¿ç«‹ã¦\n        final_prompt\
          \ = \". \".join(filter(None, parts))\n        \n        # ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ \n     \
          \   style_to_use = overall_style if overall_style else \"anime comic style,\
          \ clear lines, vibrant colors\"\n        final_prompt += f\". Style: {style_to_use}.\
          \ Aspect ratio 2:3. Consistent character design across all panels.\"\n \
          \       \n        return final_prompt.strip()\n    \n    # ãƒ¡ã‚¤ãƒ³å‡¦ç†é–‹å§‹\n   \
          \ panel_json_strings_list = []\n    \n    # å…¥åŠ›ã®å‡¦ç†\n    if isinstance(panel_jsons_input,\
          \ dict) and \"output\" in panel_jsons_input:\n        panel_json_strings_list\
          \ = panel_jsons_input.get(\"output\", [])\n    elif isinstance(panel_jsons_input,\
          \ list):\n        panel_json_strings_list = panel_jsons_input\n    else:\n\
          \        return {\n            \"error\": \"Input 'panel_jsons_input' is\
          \ missing or not in expected format.\",\n            \"image_generation_prompts_list\"\
          : [],\n            \"debug_parsed_panels\": []\n        }\n    \n    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ\n\
          \    image_prompts = []\n    parsed_panel_data_for_debug = []\n    \n  \
          \  for index, panel_json_str_raw in enumerate(panel_json_strings_list):\n\
          \        if not isinstance(panel_json_str_raw, str):\n            error_detail\
          \ = f\"Item at index {index} is not a string\"\n            image_prompts.append(f\"\
          Error: {error_detail}\")\n            parsed_panel_data_for_debug.append({\"\
          error\": error_detail})\n            continue\n        \n        # ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®é™¤å»\n\
          \        match = re.search(r\"```(?:json)?\\s*([\\s\\S]*?)\\s*```\", panel_json_str_raw)\n\
          \        if match:\n            cleaned_json_str = match.group(1).strip()\n\
          \        else:\n            cleaned_json_str = panel_json_str_raw.strip()\n\
          \        \n        try:\n            panel_data = json.loads(cleaned_json_str)\n\
          \            if not isinstance(panel_data, dict):\n                raise\
          \ ValueError(\"Parsed data is not a dictionary\")\n            \n      \
          \      parsed_panel_data_for_debug.append(panel_data)\n            \n  \
          \          # overall_styleã®å–å¾—\n            overall_style = panel_data.get(\"\
          overall_style\", \"manga style, bright colors\")\n            \n       \
          \     # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ\n            img_prompt = construct_image_prompt_from_panel_dict(panel_data,\
          \ overall_style)\n            image_prompts.append(img_prompt)\n       \
          \     \n        except Exception as e:\n            error_detail = f\"Error\
          \ at index {index}: {str(e)}\"\n            image_prompts.append(error_detail)\n\
          \            parsed_panel_data_for_debug.append({\"error\": error_detail})\n\
          \    \n    return {\n        \"image_generation_prompts_list\": image_prompts,\n\
          \        \"debug_parsed_panels\": parsed_panel_data_for_debug\n    }"
        code_language: python3
        desc: ''
        outputs:
          debug_parsed_panels:
            children: null
            type: array[object]
          image_generation_prompts_list:
            children: null
            type: array[string]
        selected: false
        title: ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ„ã¿ç«‹ã¦
        type: code
        variables:
        - value_selector:
          - '1746707845164'
          - output
          variable: panel_jsons_input
      height: 54
      id: '1746788803036'
      position:
        x: 1410.9084354875936
        y: 295.1417343060362
      positionAbsolute:
        x: 1410.9084354875936
        y: 295.1417343060362
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: ''
        error_handle_mode: terminated
        height: 334
        is_parallel: true
        iterator_selector:
        - '1746788803036'
        - image_generation_prompts_list
        output_selector:
        - '1747134234498'
        - files
        output_type: array[file]
        parallel_nums: 10
        selected: false
        start_node_id: 1747134201151start
        title: ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ 2
        type: iteration
        width: 388
      height: 334
      id: '1747134201151'
      position:
        x: 1734.7759841064933
        y: 280.21763115836654
      positionAbsolute:
        x: 1734.7759841064933
        y: 280.21763115836654
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 388
      zIndex: 1
    - data:
        desc: ''
        isInIteration: true
        selected: false
        title: ''
        type: iteration-start
      draggable: false
      height: 48
      id: 1747134201151start
      parentId: '1747134201151'
      position:
        x: 24
        y: 68
      positionAbsolute:
        x: 1758.7759841064933
        y: 348.21763115836654
      selectable: false
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom-iteration-start
      width: 44
      zIndex: 1002
    - data:
        desc: ''
        isInIteration: true
        isInLoop: false
        is_team_authorization: true
        iteration_id: '1747134201151'
        output_schema: null
        paramSchemas:
        - auto_generate: null
          default: null
          form: llm
          human_description:
            en_US: Detailed description of the image you want to generate (max 32000
              chars). Check the official OpenAI documentation for GPT Image.
            ja_JP: Detailed description of the image you want to generate (max 32000
              chars). Check the official OpenAI documentation for GPT Image.
            pt_BR: DescriÃ§Ã£o detalhada da imagem que vocÃª deseja gerar (mÃ¡x 32000
              chars). Verifique a documentaÃ§Ã£o oficial da OpenAI para GPT Image.
            zh_Hans: æ‚¨æƒ³è¦ç”Ÿæˆçš„å›¾åƒçš„è¯¦ç»†æè¿°ï¼ˆæœ€å¤š 32000 å­—ç¬¦ï¼‰ã€‚è¯·æŸ¥çœ‹ GPT Image çš„ OpenAI å®˜æ–¹æ–‡æ¡£ã€‚
          label:
            en_US: Prompt
            ja_JP: Prompt
            pt_BR: Prompt
            zh_Hans: æç¤ºè¯
          llm_description: Detailed image prompt for GPT Image (max 32000 characters).
            Describe the desired image clearly.
          max: null
          min: null
          name: prompt
          options: []
          placeholder: null
          precision: null
          required: true
          scope: null
          template: null
          type: string
        - auto_generate: null
          default: auto
          form: form
          human_description:
            en_US: Select the image size
            ja_JP: Select the image size
            pt_BR: Selecione o tamanho da imagem
            zh_Hans: é€‰æ‹©å›¾åƒå¤§å°
          label:
            en_US: Image size
            ja_JP: Image size
            pt_BR: Tamanho da imagem
            zh_Hans: å›¾åƒå¤§å°
          llm_description: ''
          max: null
          min: null
          name: size
          options:
          - label:
              en_US: Auto
              ja_JP: Auto
              pt_BR: AutomÃ¡tico
              zh_Hans: è‡ªåŠ¨
            value: auto
          - label:
              en_US: Square (1024x1024)
              ja_JP: Square (1024x1024)
              pt_BR: Quadrado (1024x1024)
              zh_Hans: æ–¹å½¢ (1024x1024)
            value: 1024x1024
          - label:
              en_US: Portrait (1024x1536)
              ja_JP: Portrait (1024x1536)
              pt_BR: Retrato (1024x1536)
              zh_Hans: ç«–å±/è‚–åƒ (1024x1536)
            value: 1024x1536
          - label:
              en_US: Landscape (1536x1024)
              ja_JP: Landscape (1536x1024)
              pt_BR: Paisagem (1536x1024)
              zh_Hans: æ¨ªå±/é£æ™¯ (1536x1024)
            value: 1536x1024
          placeholder: null
          precision: null
          required: false
          scope: null
          template: null
          type: select
        - auto_generate: null
          default: 1
          form: form
          human_description:
            en_US: Number of images to generate (Must be less than 10).
            ja_JP: Number of images to generate (Must be less than 10).
            pt_BR: NÃºmero de imagens a gerar (Deve ser menor que 10).
            zh_Hans: è¦ç”Ÿæˆçš„å›¾åƒæ•°é‡ï¼ˆå¿…é¡»å°äº 10ï¼‰ã€‚
          label:
            en_US: Number of images
            ja_JP: Number of images
            pt_BR: NÃºmero de imagens
            zh_Hans: å›¾åƒæ•°é‡
          llm_description: ''
          max: 10
          min: 1
          name: n
          options: []
          placeholder: null
          precision: null
          required: false
          scope: null
          template: null
          type: number
        - auto_generate: null
          default: auto
          form: form
          human_description:
            en_US: Select the image quality
            ja_JP: Select the image quality
            pt_BR: Selecione a qualidade da imagem
            zh_Hans: é€‰æ‹©å›¾åƒè´¨é‡
          label:
            en_US: Image quality
            ja_JP: Image quality
            pt_BR: Qualidade da imagem
            zh_Hans: å›¾åƒè´¨é‡
          llm_description: ''
          max: null
          min: null
          name: quality
          options:
          - label:
              en_US: Auto
              ja_JP: Auto
              pt_BR: AutomÃ¡tico
              zh_Hans: è‡ªåŠ¨
            value: auto
          - label:
              en_US: Low
              ja_JP: Low
              pt_BR: Baixa
              zh_Hans: ä½
            value: low
          - label:
              en_US: Medium
              ja_JP: Medium
              pt_BR: MÃ©dia
              zh_Hans: ä¸­
            value: medium
          - label:
              en_US: High
              ja_JP: High
              pt_BR: Alta
              zh_Hans: é«˜
            value: high
          placeholder: null
          precision: null
          required: false
          scope: null
          template: null
          type: select
        - auto_generate: null
          default: auto
          form: form
          human_description:
            en_US: Select the image background type. Transparent requires PNG or WebP
              format and works best with medium/high quality.
            ja_JP: Select the image background type. Transparent requires PNG or WebP
              format and works best with medium/high quality.
            pt_BR: Selecione o tipo de fundo da imagem. Fundo transparente requer
              formato PNG ou WebP e funciona melhor com qualidade mÃ©dia/alta.
            zh_Hans: é€‰æ‹©å›¾åƒèƒŒæ™¯ç±»å‹ã€‚é€æ˜èƒŒæ™¯éœ€è¦ PNG æˆ– WebP æ ¼å¼ï¼Œå¹¶ä¸”æœ€é€‚ç”¨äºä¸­/é«˜è´¨é‡ã€‚
          label:
            en_US: Background
            ja_JP: Background
            pt_BR: Fundo
            zh_Hans: èƒŒæ™¯
          llm_description: ''
          max: null
          min: null
          name: background
          options:
          - label:
              en_US: Auto
              ja_JP: Auto
              pt_BR: AutomÃ¡tico
              zh_Hans: è‡ªåŠ¨
            value: auto
          - label:
              en_US: Opaque
              ja_JP: Opaque
              pt_BR: Opaco
              zh_Hans: ä¸é€æ˜
            value: opaque
          - label:
              en_US: Transparent
              ja_JP: Transparent
              pt_BR: Transparente
              zh_Hans: é€æ˜
            value: transparent
          placeholder: null
          precision: null
          required: false
          scope: null
          template: null
          type: select
        - auto_generate: null
          default: auto
          form: form
          human_description:
            en_US: Select the output image format.
            ja_JP: Select the output image format.
            pt_BR: Selecione o formato da imagem de saÃ­da.
            zh_Hans: é€‰æ‹©è¾“å‡ºå›¾åƒæ ¼å¼ã€‚
          label:
            en_US: Output Format
            ja_JP: Output Format
            pt_BR: Formato de SaÃ­da
            zh_Hans: è¾“å‡ºæ ¼å¼
          llm_description: ''
          max: null
          min: null
          name: output_format
          options:
          - label:
              en_US: Auto
              ja_JP: Auto
              pt_BR: AutomÃ¡tico
              zh_Hans: è‡ªåŠ¨
            value: auto
          - label:
              en_US: PNG
              ja_JP: PNG
              pt_BR: PNG
              zh_Hans: PNG
            value: png
          - label:
              en_US: JPEG
              ja_JP: JPEG
              pt_BR: JPEG
              zh_Hans: JPEG
            value: jpeg
          - label:
              en_US: WebP
              ja_JP: WebP
              pt_BR: WebP
              zh_Hans: WebP
            value: webp
          placeholder: null
          precision: null
          required: false
          scope: null
          template: null
          type: select
        - auto_generate: null
          default: 100
          form: form
          human_description:
            en_US: Set compression level (0-100) for JPEG/WebP formats.
            ja_JP: Set compression level (0-100) for JPEG/WebP formats.
            pt_BR: Defina o nÃ­vel de compressÃ£o (0-100) para formatos JPEG/WebP.
            zh_Hans: è®¾ç½® JPEG/WebP æ ¼å¼çš„å‹ç¼©çº§åˆ«ï¼ˆ0-100ï¼‰ã€‚
          label:
            en_US: Output Compression
            ja_JP: Output Compression
            pt_BR: CompressÃ£o de SaÃ­da
            zh_Hans: è¾“å‡ºå‹ç¼©
          llm_description: ''
          max: 100
          min: 0
          name: output_compression
          options: []
          placeholder: null
          precision: null
          required: false
          scope: null
          template: null
          type: number
        - auto_generate: null
          default: auto
          form: form
          human_description:
            en_US: Control content moderation level.
            ja_JP: Control content moderation level.
            pt_BR: Controle o nÃ­vel de moderaÃ§Ã£o de conteÃºdo.
            zh_Hans: æ§åˆ¶å†…å®¹å®¡æ ¸çº§åˆ«ã€‚
          label:
            en_US: Moderation
            ja_JP: Moderation
            pt_BR: ModeraÃ§Ã£o
            zh_Hans: å†…å®¹å®¡æ ¸
          llm_description: ''
          max: null
          min: null
          name: moderation
          options:
          - label:
              en_US: Auto
              ja_JP: Auto
              pt_BR: AutomÃ¡tico
              zh_Hans: è‡ªåŠ¨
            value: auto
          - label:
              en_US: Low
              ja_JP: Low
              pt_BR: Baixo
              zh_Hans: ä½
            value: low
          placeholder: null
          precision: null
          required: false
          scope: null
          template: null
          type: select
        params:
          background: ''
          moderation: ''
          n: ''
          output_compression: ''
          output_format: ''
          prompt: ''
          quality: ''
          size: ''
        provider_id: langgenius/openai_tool/openai
        provider_name: langgenius/openai_tool/openai
        provider_type: builtin
        selected: false
        title: GPT Image Generate
        tool_configurations:
          background: auto
          moderation: auto
          n: 1
          output_compression: 100
          output_format: auto
          quality: auto
          size: 1024x1536
        tool_description: GPT Image Generate (gpt-image-1) is a text to image generation
          tool
        tool_label: GPT Image Generate
        tool_name: gpt_image_generate
        tool_parameters:
          prompt:
            type: mixed
            value: '{{#1747134201151.item#}}'
        type: tool
      height: 246
      id: '1747134234498'
      parentId: '1747134201151'
      position:
        x: 126.28972386542591
        y: 68
      positionAbsolute:
        x: 1861.0657079719192
        y: 348.21763115836654
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
      zIndex: 1002
    viewport:
      x: -149.95877676932264
      y: 84.81371239710143
      zoom: 0.4967556237728489
