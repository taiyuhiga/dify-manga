# 要件定義書: Dify漫画生成・表示アプリケーション

## 1. 概要

本プロジェクトは、Difyで作成されたAI漫画生成APIを利用し、ユーザーが入力した内容に基づいて漫画を生成し、ウェブブラウザ上で縦スクロールおよびスライド形式で表示するNext.jsアプリケーションを開発することを目的とする。

## 2. 機能要件

### 2.1. ユーザー入力インターフェース
- ユーザーが「質問内容」をテキストで入力できるフォームを設ける。
- ユーザーが「理解レベル」（例：初心者、中級者、上級者など）を選択または入力できるフォームを設ける。
- 「漫画を生成する」ボタンを設ける。

### 2.2. Dify API連携
- ユーザーが入力した「質問内容」と「理解レベル」を元に、Next.jsのAPIルートを経由してDifyの漫画生成API (`https://api.dify.ai/v1/workflows/run`) にリクエストを送信する。
- APIキー (`app-XeQCpyZqvXGFBTYVqdAx1byz`) はサーバーサイド（Next.js APIルート）で安全に管理し、Dify APIへのリクエスト時に使用する。
- Dify APIからのレスポンス（生成された漫画の画像URLリストを含むJSON）を適切に処理する。
    - 画像URLは、レスポンスJSONの `data.outputs.text[].url` から取得する。

### 2.3. 漫画表示
- Dify APIから取得した画像URLリストに基づき、生成された漫画の各コマをウェブページ上に縦方向に連結して表示する。
- 画像の読み込み中やエラー発生時のフィードバックをユーザーに表示する。

### 2.4. スライドショー機能
- 縦に表示された漫画のコマを、左右のナビゲーション（矢印ボタンなど）やスワイプ操作（モバイルの場合）で1コマずつスライド表示できるようにする。
- 現在表示されているコマのインジケーター（例： X / Y枚目）を表示する（任意）。

## 3. 非機能要件

### 3.1. 使用技術
- フロントエンド・バックエンド: Next.js (App Router, TypeScript)
- スタイリング: CSS Modules または Tailwind CSS (検討)
- スライド機能ライブラリ: Swiper.js または同等のライブラリ (検討)

### 3.2. セキュリティ
- Dify APIキーはフロントエンドに露出させず、環境変数としてサーバーサイドで管理する。

### 3.3. エラーハンドリング
- APIリクエスト失敗時や、予期せぬレスポンス受信時に、ユーザーにわかりやすいエラーメッセージを表示する。
- サーバーサイドのログにもエラー詳細を記録する。

### 3.4. パフォーマンス
- 画像の遅延読み込み（Lazy Loading）を検討し、初期表示速度の低下を防ぐ。

## 4. 画面構成案（イメージ）

- **入力エリア**:
    - ページ上部に「質問内容」のテキストエリアと「理解レベル」の入力フィールド、及び「生成ボタン」を配置。
- **表示エリア**:
    - 入力エリアの下に、生成された漫画が縦に表示される。
    - スライドショー有効時は、1コマずつ表示され、ナビゲーション要素が周囲に配置される。

## 5. API仕様（Dify連携）

- **エンドポイント**: `POST https://api.dify.ai/v1/workflows/run`
- **認証ヘッダー**: `Authorization: Bearer {DIFY_API_KEY}`
- **リクエストボディ (JSON)**:
  ```json
  {
    "inputs": {
      "user_question": "ユーザー入力の質問",
      "user_level": "ユーザー入力のレベル"
    },
    "response_mode": "blocking",
    "user": "nextjs-manga-viewer-user"
  }
  ```
- **レスポンスボディ (JSON - 成功時抜粋)**:
  ```json
  {
    "data": {
      "outputs": {
        "text": [
          { "type": "image", "transfer_method": "remote_url", "url": "画像1のURL", ... },
          { "type": "image", "transfer_method": "remote_url", "url": "画像2のURL", ... }
        ]
      }
    }
  }
  ```

## 6. 開発環境

- Node.js (最新LTS版)
- npm または yarn
- Git

## 7. 今後の拡張案（任意）

- 理解レベルに応じた質問のサジェスト機能。
- 生成された漫画の保存・共有機能。
- ユーザーアカウント機能と履歴保存。
- ストリーミングモード (`response_mode: "streaming"`) の活用による体感速度向上。 